@{
    ViewData["Title"] = "Index";
    Layout = "~/Views/Shared/_Layout.cshtml";
}


@if (!String.IsNullOrEmpty(ViewBag.ERROR))
{
    <div class="alert alert-danger" role="alert">
        @ViewBag.ERROR
    </div>
}

<div class="reservation-wrapper px-5 py-5 my-3">

    <div class="form-row col-12 reservation-top pb-4">
        <div class="col-12 col-lg-4 left-section my-3">
            <h4>Patient profiles</h4>
            @if (ViewBag.PatientCount > 0)
            {
                <div class="list-group patientProfile" id="list-tab" role="tablist">
                    @foreach (var patient in ViewBag.PatientList)
                    {
                        <a class="list-group-item list-group-item-action"
                           id="@patient.Id"
                           data-toggle="list"
                           href="#"
                           role="tab"
                           onclick="choosePatient(@patient.Id)">
                            <div class="card-body">
                                <h5 class="card-title"><strong>@patient.PatientName</strong></h5>
                                <input type="hidden" value="@patient.Id" name="txtPatientId" />
                                <p class="card-text">
                                    <strong>Gender:</strong>
                                    @if (patient.Gender)
                                    {
                                        <span>Male</span>
                                    }
                                    else
                                    {
                                        <span>Female</span>
                                    }
                                </p>
                                <p class="card-text">
                                    <strong>Birthdate:</strong> @patient.Birthdate.ToString("dd-MM-yyyy")
                                </p>
                            </div>
                        </a>
                    }
                    <a asp-controller="Patients" asp-action="Create" class="text-center my-3 addPatientLink">Add new patient profile</a>
                    <div class="alert alert-danger my-3" id="patientError" role="alert" hidden>
                        You have to choose a patient to make reservation.
                    </div>
                </div>
            }
            else
            {
                <div class="mb-5">
                    <h5 style="margin-top: 40%">You have not added any patient yet.</h5>
                    <small>(Need at least a patient to make an appointment)</small>
                </div>
                <a asp-controller="Patients" asp-action="Create" class="text-center my-3 addPatientLink">Add new patient</a>
            }
        </div>

        <div class="col-12 col-lg-8 right-section">
            <div class="container-fluid px-0 px-sm-4 mx-auto">
                <div class="col-12">
                    <form asp-controller="Reservations" asp-action="Create" autocomplete="off" method="post" id="reservationForm">
                        <div class="form-group col-lg-6 mb-4 service-choose">
                            <label class="control-label">Service</label>
                            <select class="form-control" asp-items="ViewBag.Service" name="serviceId"></select>
                        </div>
                        <div class="card border-0">
                            <div class="card-header bg-primary">
                                <div class="mx-0 mb-0 row justify-content-sm-center justify-content-start px-1">
                                    <input type="text" id="dp1" class="datepicker" placeholder="Pick Date" name="dateReservation" readonly>
                                    <span class="fa fa-calendar"></span>
                                </div>
                            </div>

                            <div class="card-body p-3 p-sm-5">
                                <div class="row text-center mx-0">
                                    @foreach (var timeObj in ViewBag.TimeList)
                                    {
                                        <div class="col-md-2 col-4 my-1 px-2">
                                            <div class="cell py-1" onclick="chooseTime(this)">@timeObj.TimeString</div>
                                        </div>
                                    }
                                </div>
                            </div>
                        </div>
                        <input name="patientId" id="chosenPatientId" hidden />
                        <input name="timeReservation" id="timeReservation" hidden />
                    </form>

                    <div class="alert alert-danger my-3" id="datetimeError" role="alert" hidden>
                        You have to choose date and time for reservation.
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="reservation-bottom col-12">
        <div class="text-center">
            <button type="button" onclick="submitReservation()" class="btn btn-success col-lg-4">Complete</button>
        </div>
    </div>
</div>

@section Styles {
    <link href="@Url.Content("~/css/reservation/index.css")" rel="stylesheet" type="text/css" />
}

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/js/bootstrap-datepicker.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.4.1/js/bootstrap.js"></script>
    <script>
        $(document).ready(function () {

            $('.datepicker').datepicker({
                format: 'dd-mm-yyyy',
                autoclose: true,
                startDate: '0d'
            });

            $('.cell').click(function () {
                $('.cell').removeClass('select');
                $(this).addClass('select');
            });

        });
    </script>
    <script>
        function choosePatient(id) {
            $("#chosenPatientId").val(id);
        }
    </script>
    <script>
        function chooseTime(e) {
            $("#timeReservation").val(e.innerText);
        }
    </script>
    <script>
        function submitReservation() {
            let status = true;
            var dateReservation = $("#dp1").val();
            var timeReservation = $("#timeReservation").val();
            var patientId = $("#chosenPatientId").val();
            if (dateReservation == '' || timeReservation == '') {
                $("#datetimeError").attr("hidden", false);
                status = false;
            }
            if (patientId == '') {
                $("#patientError").attr("hidden", false);
                status = false;
            }
            if (status) {
                console.log("PatientID: " + patientId + " Date: " + dateReservation + " Time: " + timeReservation);
                $("#reservationForm").submit();
            } else return
        }
    </script>

}
